## network layer:

1. 主要任务：实现网络互联——数据包的端到端传输

2. 解决问题：a. 向传输层提供服务：数据报—无连接or虚电路—有连接

   b. 网络层寻址（IP地址）

   ​		   c. 路由选择 

3. 路由算法：aim：cost最小的路

   ​		    classify：静态路径，人工配置；动态路由：有路由算法动态计算

   basic: 最短路径算法；flooding算法(使用hop counter/记录last sequence防止无限重复)

   a. 距离向量路由：

   ​	每个节点只从邻居获得状态更新，根据邻居传递的路由表更新自身的路由表

   ​	**无穷计数问题：一条更新消息可能要经过很长时间才能让路由表条目收敛

   ​		solution: 跳数限制-一条消息传播一定次数就丢弃

   b. 链路状态路由（需要知道整个网络结构）

   1) 通过Hello数据包找邻居
   2) 构建链路状态数据包(所有邻居花费 + seq, age标识)
   3) 分发数据包(注意数据包的转发和ack) 
   4) 用最短路径算法计算该router到所有其他的最短路径

   c. 层次路由 （用于大型网络自治系统间路由）

   1. 每个自治系统的网关路由器将其通过自治系统间路由协议获得的可达路径
   2. 网关路由器传递给自治系统内部所有路由器
   3. 所有路由器根据自身到这些网关路由器的代价，在路由表中记录到其他自治系统需要经过从哪个端口转发数据

   d. 广播路由

   	1. 当一个主机需给多个主机发消息时使用泛洪算法发送数据包
   	1. 其他主机收到消息后，根据逆向路径转发思想——数据包发来的线路是否为从A到B传输的最佳线路。
   	1. 如是，则向其他端口转发，如否，丢弃

   e. 多播路由

   ​	solution1：为每个组中的每个路由器生成多播树

   ​	solution2：将一个节点作为核心生成一颗多播树，所有多播数据要经过核心的转发

   ​			（无法最优但节约空间）

   f. 任播路由：发送数据包到组内任何成员都可，可使用DVR或LSR

4. 流量管理——必要性：网络的带宽，存储空间，处理器机能的有限导致拥塞，需要管理

   拥塞控制：确保整体通讯子网可以承载通讯量

   流量控制：确保发送方到接收方通信的流量合理

   a. 流量感知路由：将网络流量缓慢引导到其他非拥塞的链路以缓解拥塞（需要多路径的路由）

   b. 准入控制：用于虚电路的拥塞预防技术，对新建的虚电路进行审核，当其不会导致网络拥塞时接入，否则拒绝建立

   c. 负载脱落：直接丢弃数据包（丢弃老的数据包Milk方案；丢弃新的数据包Wine方案）

   d. 流量整形：拥塞由突发大流量造成，所以可以强迫包以一定的速度发
       漏桶: 桶内存放数据包，并使数据包以恒定速度流出，满桶后数据丢弃

   ​    令牌桶：桶内存放数据令牌，只有拥有数据包大小的令牌的数据包才能发出，且令牌以恒定速度流入桶，满桶不流入

   e. 随机早期检测RED：当某条链路平均队列长度超过阈值随机丢包

   f. 显示拥塞告知ECN：发送抑制数据包/数据包中打拥塞标记以通知发送发链路拥塞

   g. 逐跳后压：接受方发送抑制数据包使链路上的每一跳都受到抑制

5. 服务质量QoSQoE：延迟，带宽，抖动，丢失

   包调度：FIFO，RR，Weighted Fair Queue

   综合服务：资源预留协议：沿着组播生成树往上走做预留

   区分服务：基于类别的服务质量，单跳行为（在服务器的待遇）；加速转发：开了一个新的快道 确保转发：先过分类器，再过监管器，生成 12 个 服务区别（4 个分类 3 个丢包），进 WFQ

6. 网络互联

   a. 异构网络互联: 每个网络的物理结构(物理，链路层)不同，如何连接这些网络？ 

   ways: 将每种网络的数据包翻译成其他网络的数据包; 

   ​	   在网络上增加一层公共层解决问题(网络层的提出)

   b. 支持不同数据包长度 （path MTU）路径最大传输单元

   ​	ways: 分片 — 透明分包，由路由器进行分包和重组

   ​			— 非透明分包，路由器只进行分包，但分包有额外开销且一些链路不需要

   ​		   MTU discovery 通过链路中报错，使发送的数据包达到链路的MTU限制

7. Internet网络层

   a. IPV4格式

   ​	4byte：| Version 4btis| 首部长度 4bits | 区分服务 8bits | 总长度16 bits |

   ​	4byte：| 标识 16bits—同属一个数据报的分片具有相同的标识|

   ​	标志：预留 + DF(don't frag 0表示允许分片) + MF(more frag 1表示后续还有分段) 3bits | 

   ​	片偏移 13btis —片起始位置在数据包中的偏移（要求除最后一个片外其他必须片长8字节的整数倍）|

   ​	4byte：| 生存时间hops 8bits | 协议 8bits | 首部checksum 16bits  |   

   ​	4byte：| source address 32bits|

   ​	4byte：|destination address 32bits|

   ​	|可变部分 + 填充|

​	b. ip地址

​		base：使用点分十进制表示IP地址：192.168.0.1/16 "/"后数字表示网络位数  每一个网络接口对应一个IP地址

​		i. 分类编址：

​		<img src=".\images\image-20231223192528756.png" alt="image-20231223192528756" style="zoom:20%;" />

​		*特殊地址：全0-本主机；全1-本地网络广播；网络号全0，主机号any-本网络任意主机；127.any-本地回环

​		ii. 子网编址：

​		将网络中的部分主机号作为子网号使用：128.208.128.0/17 子网掩码：255.255.128.0

​		iii. CiDR无类域间路由

​		路由聚合：寻找多个网络的最长公共前缀聚合成一个超网存储到路由器中以减少路由表条目

​		最长前缀匹配：若转发时发现有多条路由可选，选择网络前缀最长的那条

​		iv. 网络地址转换NAT——解决IP地址耗尽

​		内网中主机使用私有地址（10.0.0.0/172.16.0.0/192.168.0.0）

​		向公网主机发送消息时，通过NAT将source内网IP转化为NAT IP池中的公网IP

​		*但是这样在内网中只有有限的主机能同时与公网通信

​	c. Internet协议

​		ICMP Internet消息控制协议：用于差错或异常的报告/网络探寻，包裹在IP数据报中

​		ARP 地址解析协议：主机1广播请求，主机2以自己的MAC应答，不同网段请求网关的MAC地址，所有解析条目存入ARP缓存，会定期更新

​		DHCP 动态主机设置协议：动态配置主机的IP地址，应用层协议，基于UDP和广播

​		DHCP发现+DHCP提供+DHCP请求+DHCP确定

​	d. OSPF — a kind of IGP 域内路由协议

​		链路状态路由的实际使用版

​		Hello问候分组找邻居+构造发送DD数据库描述分组+其他站根据收到的DD发送LSR链路请求+该站发送LSU链路状态更新+LSAck

​	分区：主干区域+其他

​	e. BGP — a kind of EGP 域间路由协议

​		层次路由的实际使用版：通过BGP发言人选择域间路由

**IPV6:

​	更简单的首都设计(40B)，更大的地址（16B）拓展头添加到有效载荷中，使用NextHeader指向，路由器不进行分段，Discovery MTU

​		



​		 
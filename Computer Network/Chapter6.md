## Transport layer

1. 传输层任务：为应用进程间提供端到端的服务

2. 主要功能：传输层寻址；提供有连接(TCP)和无连接(UDP)的服务；服用和分解；错误和流量控制

3. 传输协议要素：

   a. 寻址：通过IP地址+端口号标识一个TSAP，除一些应用有熟知端口外其他端口通过端口映射器登记并分配

   ​	此外，使用初始连接协议：使用进程服务器代理不频繁使用的服务器

   b. 连接建立：prob: 连接确认没有及时到达导致的多重连接

   ​			solve：增加packet seq/ 限制packet lifetime(hop)

   ​			三次握手：

   <img src=".\images\image-20231224113058445.png" alt="image-20231224113058445" style="zoom:25%;" />

   c. 连接释放：prob: 非对称释放导致数据丢失，对称释放要求每个单向连接单独释放，但可能一边的请求丢失

   ​			solve: 三次握手+计时器（有可能造成半开连接）

   <img src=".\images\image-20231224123225372.png" alt="image-20231224123225372" style="zoom:25%;" />

   ​			如果host1计时器未收到DR消息则重传，多次重传失败则直接关闭

   ​			如果host2计时器未收到ack则直接关闭

   d. 差错流量控制：使用停-等协议和滑动窗口

   ​	*传输层连接多带宽延迟积大，所以使用动态的缓存分配策略

    1. 缓冲区组织方式：链式固定大小（浪费）；链式可变大小（管理复杂）；大环形缓冲区

    2. 管理策略：发送端请求缓冲区，接收端尽可能分配缓冲区，发送方发送段时减少他被分配的缓冲

       接收方流量捎带确认和可用缓冲数量

   e. 多路复用：多个端口对应一个网络地址接口，通过端口号指明当段到达时要交给哪个进程处理

   f. 崩溃恢复：从第N层崩溃中的恢复 工作只能由N+1层完成

4. 拥塞控制

   expect: 利用带宽同时避免拥塞；对整个竞争公平；快速跟踪流量的变化

   ways：调整发送速度——受流量控制和拥塞控制共同影响

   ​	显示：路由器告知源端 

   ​	隐式：直接丢包

   ​	AIMD：加性增乘性减

   ​		对于精确的调整信号，可以直接改变发送速率，而对于非精确的，必须通过其他算法调整发送速率

   ​		AIMD是一种广泛使用的法则：

   ​		在网络有剩余带宽时所有用户加法添加自身带宽，当拥塞时，所有用户除法减少自身带宽，最后可达到较为公平

   **无线网络：误码造成的丢包率高，怎么进行隐式的拥塞控制？

   ​	链路层微秒级的重传机制，传输层秒级的拥塞控制机制

5. UDP

   提供不可靠的无连接服务

   格式：|source port 16btis | dst port 16bits |

   ​	    | 总长度 16bits | checksum 16bits |

   apply: RPC 远程过程调用

   ​		RTP 实时传输协议 应用层传输协议

   ​		seq：用于丢包检测

   ​		timestamp：包相对于整个流的起始时间，用于正确顺序播放流，防止抖动

   ​		synchron source identifier：用于数据复用

   ​		使用buffer防止抖动：高抖动，buffer大播放点延后，低抖动，buffer小

6. TCP协议

   协议模型：支持面向连接的可靠字节流通讯

   

   TCP段头：

   4byte | source port 16bits | dst port 16btis |

   4byte | seq number 32bits |

   4byte | ack number 32bits 下一个期待字节|

   4byte |TCP head length 4bits| CWR ECE 拥塞控制| URG紧急数据 | ACK确认号有效| PSH立即接受 | RST重置链接 | SYN 连接建立 | FIN 连接释放 | 窗口大小 16bits 流量控制 |

   4byte |checksum 16bits | 紧急指针 16bits |

   | 可选项 |

   

   TCP连接建立：

   三次握手：a. Client发送SYN=1 ACK=0 seq=x的TCP段 b. Sever接收后发送SYN=1 ACK=1 seq=y ack=x+1的段 c. Client发送SYN=0 ACK=1 seq=x+1 ack=y+1的常规数据包，此时连接建立

   **注：TCP泛洪攻击：Client发送多个SYN=1连接请求占用资源但不完成后续动作

   TCP连接释放：

   四次挥手：a. Client发送FIN=1 ACK=1 seq=x ack=y的数据段表示准备释放连接

   ​		   b. Server发送ACK=1 seq=y ack=x+1的数据段，并进入关闭等待(期间不接受Client发送，但要把之前未传输的传输完)

   ​		c. 传输完成后Server发送FIN=1 ACK=1 seq=z ack=x+1的重复确认段表示数据传输完

   ​		d. 此时Client发送ACK=1 seq=x+1 ack=z+1并等待2MSL时间， 超时关闭连接

   TCP滑动窗口(流量控制)：

   发送方可通过接收方段中的window size调整自身的发送窗口

   延迟确认：接收方可以等自身接收端口填满后在进行累积确认

   Nagle：先发送第一次到达的数据字节，后续缓冲，知道前面发送被确认或者缓冲填满再发送

   Clark：当发送窗口已经调整为0时，限制接收端只有在具备半空缓存或最大段长的空缓存时才向发出端发送窗口调整

   

   TCP计时器管理：

   prob：最佳的计时器时间？

   solve：动态调整

   ​		RTT~n~ = $\alpha$RTT~n-1~ + (1-$\alpha$)M~n~

   ​		D~n~ = $\beta$D~n-1~ + (1-$\beta$)|RTT~n~ - M~n~|

   ​		next timeout = RTT~n~ + 4 * D~n~

   ** TCP有哪些计时器？1. 超时重传 2. 持续计时器(用于窗口探测，防止0size的死锁)

   					3. 终止(2MSL关闭连接) 4. 保活计时器(查看另一端是否存在)

   

   TCP拥塞控制

   1. 确认时钟：ACK返回到发送端的速度反映了最慢链路的速度，据此控制发送端发送速度，避免拥塞
   2. 慢速启动：设置初始拥塞窗口为1，每次发送数据ack后double，直到达到threshold值
   3. 拥塞避免：达到threshold后，每次数据ack后窗口+1，若重传，threshold=size*0.5并重新慢速启动
   4. 快重传：当收到3个接收方的重复确认，发送方进行快速重传
   5. 快恢复：快重传触发后，threshold=size*0.5，size=threshold

   **TCP CUBIC：由于大的延迟带宽乘积，使用关于最后一个重复确认以来的时间的立方函数确定拥塞窗口大小




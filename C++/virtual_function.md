1. 虚函数实现机制：

   a. 编译阶段：

   虚函数的实现是通过虚函数表来实现：在程序的.rodata段每一个由虚函数的类都存在一张虚表(继承未重写的也算)，表中包含了各个虚函数的起始地址，类的类型信息(用于RTTI):
   
   <img src="./images/vtable_2.png" style="zoom:30%;" />
   
   <img src="./images/vtable_1.png" alt="vtable_1.png" style="zoom:30%;" />

当子类重写父类函数时，其虚表中该函数的地址就会发生变化，否则不变

**为什么每个类用一张虚表？节省空间

b. 对象内容

在每个对象中，我们知道子类会先(在低地址)存放父类的数据，然后再存放自己的数据。但是在存在虚表的情况下，对象会先存放虚函数相关的指向自身虚表的指针，然后是父类变量，接着才是自己的成员变量：

![](./images/obj_struct.png)

**由于虚表指针必然是指向自己的虚表的，所以其包含所有虚函数的入口(包含祖先、父类的继承，以及自身定义的虚函数)所以只需要在对象头定义一虚表指针即可

c. 使用虚函数

在运行时，首先在变量构造阶段，构造函数将虚表地址放入对象头部。在调用虚函数时，如果使用的是普通对象调用，则链接期会直接把这个函数调用直接转化为对应的函数地址，而如果使用的是指针或引用对象调用，则会通过虚表中函数地址项进行定位：

![non_pointer](F:\SummaryofComputerBasis\C++\images\non_pointer.png)

![pointer](F:\SummaryofComputerBasis\C++\images\pointer.png)